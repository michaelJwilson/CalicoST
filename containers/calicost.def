# NB apptainer build -F --build-arg-file ./config.txt ./calicost.sif ./calicost.def;
#    images are cached to $HOME/.apptainer/cache
# 
Bootstrap: docker

# NB https://hub.docker.com/r/continuumio/miniconda3
From: continuumio/miniconda3
Stage: build

%files
    ../test_environment.yml /home/usr/test_environment.yml

    # TODO HACK
    /Genomics/argo/users/mw9568/repos/CalicoST /home/usr/CalicoST

%environment
    export PATH=/home/usr/bin/:/opt/conda/envs/{{ ENV_NAME }}/bin/:$PATH

    # TODO HACK UGH
    export PYTHONPATH=/opt/conda/envs/{{ ENV_NAME }}/lib/python3.10/site-packages/:$PYTHONPATH

%post
    apt-get update

    # NB https://www.anaconda.com/blog/a-faster-conda-for-a-growing-community
    conda config --set solver libmamba

    # NB create this early to benefit from layer caching.
    conda env create -f /home/usr/test_environment.yml --name {{ ENV_NAME }}

    wget -O /home/usr/Eagle_v2.4.1.tar.gz https://storage.googleapis.com/broad-alkesgroup-public/Eagle/downloads/Eagle_v2.4.1.tar.gz
    tar -xzf /home/usr/Eagle_v2.4.1.tar.gz -C /home/usr/
    mkdir -p /home/usr/bin; cp /home/usr/Eagle_v2.4.1/eagle /home/usr/bin/

    # TODO HACK
    # git clone https://github.com/raphael-group/CalicoST.git /home/usr/CalicoST

    # TODO HACK don't rely on prefix, or python version.
    # NB add -e for editable source
    # rm -f /home/usr/CalicoST/python/calicost.egg-info

    # cd /home/usr/CalicoST; pip install --no-deps -e .


%runscript
    /bin/bash

    # NB when the container is invoked, arguments following the container name are passed to the runscript.
    echo "Arguments received: $*"
    exec echo "$@"

    echo {{ WELCOME_MESSAGE }}
    
    # conda activate {{ ENV_NAME }}
    # cd /home/usr

%test
    echo "NO AVAILABLE TESTS FOR {{ ENV_NAME }}"

%labels
    Author Michael J. Wilson
    Version v0.0.1

%help
    This is a basic container related to dev. for Calico-ST.