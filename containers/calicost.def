# NB (rm ./calicost.sif); apptainer build -F --build-arg-file ./config.txt ./calicost.sif ./calicost.def;
#    images are cached to $HOME/.apptainer/cache
# 
Bootstrap: docker

# NB https://hub.docker.com/r/continuumio/miniconda3
From: mambaorg/micromamba
Stage: build

%files
    ../mini_calicost.yaml /home/usr/mini_calicost.yaml
    ../pyproject.toml /home/usr/pyproject.toml
    ../poetry.lock /home/usr/poetry.lock

    # TODO HACK replace with git clone on PR from branch
    /Genomics/argo/users/mw9568/repos/CalicoST/python/calicost /home/usr/calicost

%environment
    export PATH=/home/usr/bin/:/opt/conda/envs/{{ ENV_NAME }}/bin/:$PATH

    # NB pip install from source
    export PYTHONPATH=/home/usr/CalicoST/python/:$PYTHONPATH

%post
    apt-get update && apt-get install -y emacs

    # NB create early to benefit from layer caching.
    wget -O /home/usr/Eagle_v2.4.1.tar.gz https://storage.googleapis.com/broad-alkesgroup-public/Eagle/downloads/Eagle_v2.4.1.tar.gz
    tar -xzf /home/usr/Eagle_v2.4.1.tar.gz -C /home/usr/
    mkdir -p /home/usr/bin; cp /home/usr/Eagle_v2.4.1/eagle /home/usr/bin/

    # NB see https://www.anaconda.com/blog/a-faster-conda-for-a-growing-community
    conda config --set solver libmamba

    conda env create -f /home/usr/mini_calicost.yaml --name {{ ENV_NAME }}

    # TODO HACK see equivalent cp above.
    # git clone https://github.com/raphael-group/CalicoST.git /home/usr/CalicoST

    # TODO HACK shouldn't be necessary
    rm -rf /home/usr/CalicoST/python/calicost.egg-info

    # NB add -e for editable source
    cd /home/usr/CalicoST; /opt/conda/envs/calicost/bin/pip install --no-deps -e .


%runscript
    /bin/bash

    # NB when the container is invoked, arguments following the container name are passed to the runscript.
    echo "Arguments received: $*"
    exec echo "$@"
   
    # conda activate {{ ENV_NAME }}
    # cd /home/usr

%test
    echo "NO AVAILABLE TESTS FOR {{ ENV_NAME }}"

%labels
    Author Michael J. Wilson
    Version v0.0.1

%help
    This is a basic container related to dev. for Calico-ST.